import type { Request, Response } from "express";
import { getPrismaClient } from "@erwininteractive/mvc";

const prisma = getPrismaClient();

/**
 * GET /<%= resourcePath %>
 * List all <%= lowerModelName %> records.
 */
export async function index(req: Request, res: Response): Promise<void> {
  try {
    const items = await prisma.<%= lowerModelName %>.findMany({
      orderBy: { createdAt: "desc" },
    });
    res.render("<%= resourcePath %>/index", { 
      title: "<%= modelName %> List",
      items,
    });
  } catch (error) {
    console.error("Error fetching <%= resourcePath %>:", error);
    res.status(500).render("error", { 
      title: "Error",
      message: "Failed to load <%= resourcePath %>",
    });
  }
}

/**
 * GET /<%= resourcePath %>/create
 * Show form to create a new <%= lowerModelName %>.
 */
export async function create(req: Request, res: Response): Promise<void> {
  res.render("<%= resourcePath %>/create", {
    title: "Create <%= modelName %>",
    item: {},
    errors: {},
  });
}

/**
 * POST /<%= resourcePath %>
 * Create a new <%= lowerModelName %> record.
 */
export async function store(req: Request, res: Response): Promise<void> {
  try {
    const data = req.body;
    const item = await prisma.<%= lowerModelName %>.create({ data });
    res.redirect(`/<%= resourcePath %>/${item.id}`);
  } catch (error) {
    console.error("Error creating <%= lowerModelName %>:", error);
    res.status(400).render("<%= resourcePath %>/create", {
      title: "Create <%= modelName %>",
      item: req.body,
      errors: { _form: "Failed to create <%= lowerModelName %>. Please check your input." },
    });
  }
}

/**
 * GET /<%= resourcePath %>/:id
 * Show a single <%= lowerModelName %> record.
 */
export async function show(req: Request, res: Response): Promise<void> {
  try {
    const id = Number(req.params.id);
    if (isNaN(id)) {
      res.status(400).render("error", { title: "Error", message: "Invalid ID" });
      return;
    }

    const item = await prisma.<%= lowerModelName %>.findUnique({ where: { id } });
    if (!item) {
      res.status(404).render("error", { 
        title: "Not Found", 
        message: "<%= modelName %> not found",
      });
      return;
    }

    res.render("<%= resourcePath %>/show", { 
      title: "<%= modelName %> Details",
      item,
    });
  } catch (error) {
    console.error("Error fetching <%= lowerModelName %>:", error);
    res.status(500).render("error", { 
      title: "Error",
      message: "Failed to load <%= lowerModelName %>",
    });
  }
}

/**
 * GET /<%= resourcePath %>/:id/edit
 * Show form to edit a <%= lowerModelName %>.
 */
export async function edit(req: Request, res: Response): Promise<void> {
  try {
    const id = Number(req.params.id);
    if (isNaN(id)) {
      res.status(400).render("error", { title: "Error", message: "Invalid ID" });
      return;
    }

    const item = await prisma.<%= lowerModelName %>.findUnique({ where: { id } });
    if (!item) {
      res.status(404).render("error", { 
        title: "Not Found", 
        message: "<%= modelName %> not found",
      });
      return;
    }

    res.render("<%= resourcePath %>/edit", {
      title: "Edit <%= modelName %>",
      item,
      errors: {},
    });
  } catch (error) {
    console.error("Error fetching <%= lowerModelName %>:", error);
    res.status(500).render("error", { 
      title: "Error",
      message: "Failed to load <%= lowerModelName %>",
    });
  }
}

/**
 * PUT /<%= resourcePath %>/:id
 * Update a <%= lowerModelName %> record.
 */
export async function update(req: Request, res: Response): Promise<void> {
  try {
    const id = Number(req.params.id);
    if (isNaN(id)) {
      res.status(400).render("error", { title: "Error", message: "Invalid ID" });
      return;
    }

    const data = req.body;
    await prisma.<%= lowerModelName %>.update({
      where: { id },
      data,
    });

    res.redirect(`/<%= resourcePath %>/${id}`);
  } catch (error) {
    console.error("Error updating <%= lowerModelName %>:", error);
    res.status(400).render("<%= resourcePath %>/edit", {
      title: "Edit <%= modelName %>",
      item: { id: req.params.id, ...req.body },
      errors: { _form: "Failed to update <%= lowerModelName %>. Please check your input." },
    });
  }
}

/**
 * DELETE /<%= resourcePath %>/:id
 * Delete a <%= lowerModelName %> record.
 */
export async function destroy(req: Request, res: Response): Promise<void> {
  try {
    const id = Number(req.params.id);
    if (isNaN(id)) {
      res.status(400).json({ error: "Invalid ID" });
      return;
    }

    await prisma.<%= lowerModelName %>.delete({ where: { id } });
    
    // Check if request wants JSON response
    if (req.accepts("json") && !req.accepts("html")) {
      res.json({ success: true });
    } else {
      res.redirect("/<%= resourcePath %>");
    }
  } catch (error) {
    console.error("Error deleting <%= lowerModelName %>:", error);
    res.status(500).json({ error: "Failed to delete <%= lowerModelName %>" });
  }
}
